#!/usr/bin/env bash

#####
## This script generates a secrets file for the active environment
#####

set -eo pipefail


if [ -z "$AZIMUTH_CONFIG_ROOT" ] || [ -z "$AZIMUTH_CONFIG_ENVIRONMENT_ROOT" ]; then
    echo "Please activate an environment" >&2
    exit 1
fi

SECRETS_FILE="$AZIMUTH_CONFIG_ENVIRONMENT_ROOT/inventory/group_vars/all/secrets.yml"

FORCE_OVERWRITE=
while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--force)
            FORCE_OVERWRITE="yes"
            shift
            ;;
        *)
            shift
            ;;
    esac
done

# If the secrets file already exists, do not overwrite it unless explicitly requested
if [ -f "$SECRETS_FILE" ]; then
    if [ "$FORCE_OVERWRITE" = "yes" ]; then
        echo "$SECRETS_FILE already exists - overwriting"
    else
        echo "$SECRETS_FILE already exists - will not overwrite" >&2
        exit 1
    fi
fi

# Write the secrets file, making sure the directory exists first
mkdir -p "$(dirname $SECRETS_FILE)"
cat <<EOF > $SECRETS_FILE
#####
# This file contains secrets for the $AZIMUTH_CONFIG_ENVIRONMENT environment
#
# It should be encrypted if stored in version control
# https://azimuth-config.readthedocs.io/en/stable/repository/secrets/
#####

# https://azimuth-config.readthedocs.io/en/stable/configuration/05-secret-key/
# The secret key for signing Azimuth cookies
azimuth_secret_key: "$(openssl rand -hex 32)"

# https://azimuth-config.readthedocs.io/en/stable/configuration/07-platform-identity/#keycloak-admin-password
# The admin password for the Keycloak master realm
keycloak_admin_password: "$(openssl rand -hex 16)"

# https://azimuth-config.readthedocs.io/en/stable/configuration/08-zenith/
# The secret key for signing Zenith registrar tokens
zenith_registrar_subdomain_token_signing_key: "$(openssl rand -hex 32)"

# https://azimuth-config.readthedocs.io/en/stable/configuration/10-kubernetes-clusters/#harbor-registry
# The password for the Harbor admin account
harbor_admin_password: "$(openssl rand -hex 16)"
# The secret key for Harbor
harbor_secret_key: "$(openssl rand -hex 8)"

# https://azimuth-config.readthedocs.io/en/stable/configuration/14-monitoring/#accessing-web-interfaces
# The admin password for Azimuth administrative dashboards
admin_dashboard_ingress_basic_auth_password: "$(openssl rand -hex 16)"
EOF
