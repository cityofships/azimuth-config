# OpenStack Blazar Reservations

!!! warning

    Blazar support is available as a preview.
    It is still under active development.
    Its possible how this feature works may radically
    change in a future release.


We are using OpenStack Blazar to give better feedback to Azimuth
users about when the cloud is full, and their requested platform
cannot be created.
This is a common issue with "fixed capacity" clouds,
where there is more demand for resources than available
capacity.

## Blazar flavor plugin

We make use of the new Blazar flavor plugin that allows
any hosts that have been added into Blazar to be reserved
by specifing both the flavor of Nova server you require
and how many of each flavor you require.
https://opendev.org/openstack/blazar/src/branch/master/blazar/plugins/flavor/flavor_plugin.py

We do not currently support the host reservation,
or the instance reservation plugins.
We may in the future support floating ip reservation.

There is active work on the Blazar flavor plugin to
improve the support for VMs with GPUs attached, and
to allow ironic nodes to be added as possible flavor
reservation targets.

Currently, we only support the case where all projects
are able to access all configured Nova flavors via Blazar.

For more information on Blazar, and how to add hosts into
Blazar's control, please see:
https://docs.openstack.org/blazar/latest/cli/flavor-based-instance-reservation.html

## Coral Credits and Blazar Enforement Plugins

Blazar has an enforcement plugin that is able to
call out to an external service to decide if a reservation
is allowed:
https://docs.openstack.org/blazar/latest/admin/usage-enforcement.html#externalservicefilter

There is a new open source service that implements this API,
called Coral Credits:
https://github.com/stackhpc/coral-credits

Coral credits can be deployed via Azimuth config,
by setting this:
```yaml  title="environments/my-site/inventory/group_vars/all/variables.yml"
coral_credits_enabled: yes
```

Details on how to configure OpenStack Blazar to contact
the Coral credits service deployed above, and how to
configure the credits assigned to each OpenStack project
are detailed in here:
https://github.com/stackhpc/coral-credits/blob/main/README.md#blazar-configuration

## Azimuth configuration

Firstly we tell Azimuth to prompt users to pick when they would
like their platform to be deleted, which tiggeres the creation
of a schedule operator lease for each platform:

```yaml  title="environments/my-site/inventory/group_vars/all/variables.yml"
azimuth_scheduling_enabled: true
```

Next we tell the Azimuth schedule operator to create Blazar leases:

```yaml  title="environments/my-site/inventory/group_vars/all/variables.yml"
azimuth_schedule_operator_blazar_enabled: true
```

The CAPI operator and CAAS operators cluster objects both have
the option for a lease reference. When configured, the schedule
operator will try to create a matching Blazar reservation.
On error, we report if the problem was due to either cloud capacity
or running out of cloud credits.
On succesfully creating a Blazar lease, the CAPI and CAAS operators
will read the lease object to understand which flavor uuids to
use when creating the platform, such that they can successfully
create the platform using the reserved resources.
