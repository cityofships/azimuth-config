# OpenStack Manila file systems

!!! warning

    Manila support is available as a preview.
    It is still under active development.
    Its possible how this feature works may radically
    change in a future release.

## Tenancy scratch file system

!!! warning

    This feature is currently only supported
    by Slurm and the Workstation platforms.
    Hopefully this will evetually be supported
    by all relevant platforms.

For projects that need to some scratch storage to persist
after the currnet platforms have been removed,
Azimuth has the option of support a per tenancy.

You can enable the automatic creation of the project
share by setting the size of the Manila share to be
created for this purpose. For example, to create a 100GB
share for each tenancy, please set this configuration:

```yaml  title="environments/my-site/inventory/group_vars/all/variables.yml"
azimuth_openstack_manila_project_share_gb: 100
```

!!! info

    Currently, the automatically created share is hardcoded
    to pick the default share type, unless there is only one
    available share type. It also assumes that share type will
    support the CephFS share protocol.

The platforms that make use of the auto created Manila
share will be given information on which Manila share
to mount, using these extra_vars:

```
cluster_project_manila_share: true
cluster_project_manila_share_name: "azimuth-project-share"
cluster_project_manila_share_user: "proj-<project_id>"
```

!!! info

    There is no automated backup or
    snapshotting of the tenancy file share.
    This is intentional, given the intended use
    cases for this scratch storage.

## Storage Network automation

To access a manila share, the platforms will
need to be able to route to storage service providing
the manila share.
This is typically not possible with the network either
tagged with "portal-internal".

As such, we have created option to detect a second 
network tagged as "portal-storage" that is provided
via additional extra vars such as:

```
cluster_storage_network: "name-of-portal-storage-network"
```

Note, for Kubernetes, you can change the template to
detect a network that is tagged with "portal-stroage".

If SR-IOV network is available for this storage network,
the workstation and slurm appliance can be configued to
create "direct" mode ports by setting:

```
azimuth_caas_stackhpc_workstation_extra_vars_overrides:
  cluster_storage_vnic_type: direct
azimuth_caas_stackhpc_slurm_appliance_extra_vars_overrides:
  cluster_storage_vnic_type: direct
```
